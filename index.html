<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dwarka Poonam Data Record</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3a86ff;
            --secondary-color: #ffbe0b;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333;
            --header-color: #444;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body.dark-mode {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #1a1a1a;
            --card-background: #2a2a2a;
            --text-color: #e0e0e0;
            --header-color: #f0f0f0;
            --border-color: #444;
            --danger-color: #f15b4c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: background-color 0.3s;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.6em;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .add-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .add-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Theme Switcher */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: rgba(0,0,0,0.2); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: #ffffff; }
        input:checked + .slider:before { transform: translateX(26px); background-color: var(--primary-color); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        main {
            padding: 30px;
        }
        
        /* Filter Styles */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: color-mix(in srgb, var(--background-color) 50%, transparent);
            border-radius: 8px;
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { font-weight: 500; font-size: 0.95em; }
        .filter-group select { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-background); color: var(--text-color); font-family: var(--font-family); font-size: 0.9em; cursor: pointer; }
        
        /* Record Count Styles */
        .record-summary {
            padding: 0 10px 15px;
            color: var(--header-color);
            font-size: 0.9em;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            transition: background-color 0.3s;
        }

        th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--header-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Styles for Row Coloring by Month - UPDATED with solid colors */
        .color-group-1 { background-color: var(--card-background); }
        .color-group-2 { background-color: color-mix(in srgb, var(--primary-color) 8%, var(--card-background)); }
        tr.color-group-1:hover, tr.color-group-1:hover td.actions { background-color: color-mix(in srgb, var(--text-color) 5%, var(--card-background)); }
        tr.color-group-2:hover, tr.color-group-2:hover td.actions { background-color: color-mix(in srgb, var(--primary-color) 15%, var(--card-background)); }
        
        .actions button {
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.3s, transform 0.2s;
        }

        .actions button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Styles for Sticky Column */
        th.actions, td.actions { position: sticky; right: 0; z-index: 1; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }
        body.dark-mode th.actions, body.dark-mode td.actions { box-shadow: -2px 0 5px rgba(0,0,0,0.3); }
        th.actions { background-color: var(--background-color); }
        
        /* FIX: Explicitly set background for sticky action cells to prevent overlap - UPDATED with solid colors */
        .color-group-1 td.actions { background-color: var(--card-background); }
        .color-group-2 td.actions { background-color: color-mix(in srgb, var(--primary-color) 8%, var(--card-background)); }

        .edit-btn svg { fill: #f39c12; }
        .delete-btn svg { fill: var(--danger-color); }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-background); margin: 8% auto; padding: 30px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); animation: slideIn 0.4s; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-btn:hover { color: var(--text-color); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Form Styles */
        #form-fields-container { max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        #form-fields-container > div { transition: all 0.3s ease-in-out; }
        form label { display: block; margin-bottom: 8px; font-weight: 500; }
        form input, form select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; background-color: var(--background-color); color: var(--text-color); transition: border-color 0.3s, box-shadow 0.3s; font-family: var(--font-family); font-size: 1em; }
        form input:focus, form select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
        .duration-picker, .day-month-picker { display: flex; gap: 10px; margin-bottom: 15px; }
        .duration-picker select, .day-month-picker select { flex: 1; margin-bottom: 0; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .form-actions button { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: transform 0.2s, opacity 0.3s; }
        .form-actions button:hover { transform: translateY(-2px); opacity: 0.9; }
        
        #save-btn { background-color: var(--primary-color); color: white; position: relative; min-width: 90px; }
        #cancel-btn, #confirm-cancel-btn { background-color: #ccc; }
        #confirm-ok-btn { background-color: var(--danger-color); color: white; }
        
        /* Loader Styles */
        .loader-container { text-align: center; padding: 50px; }
        .loader { border: 5px solid color-mix(in srgb, var(--primary-color) 20%, transparent); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Improved Button Loader */
        .btn-loader { border: 2px solid rgba(255, 255, 255, 0.4); border-top: 2px solid #ffffff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; margin-top: -9px; margin-left: -9px; }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Dwarka Poonam Data Record</h1>
            <div class="header-controls">
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle" />
                        <div class="slider round"></div>
                    </label>
                </div>
                <button class="add-btn" id="addNewBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Add New</span>
                </button>
            </div>
        </header>
        <main>
            <div class="filter-container">
                <div class="filter-group">
                    <label for="yearFilter">Filter by Year:</label>
                    <select id="yearFilter"><option value="all">All Years</option></select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">Filter by Date:</label>
                    <select id="dateFilter"><option value="all">All Dates</option></select>
                </div>
            </div>
            
            <!-- NEW: Record Count Display -->
            <div class="record-summary">
                <p id="record-count-display"></p>
            </div>
            
            <div id="loader" class="loader-container">
                <div class="loader"></div>
                <p>Loading Data...</p>
            </div>
            <div class="table-container" id="table-wrapper" style="display:none;">
                <table>
                    <thead id="data-table-head"></thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modals (Data Entry, Confirmation, Info) -->
    <div id="data-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Add New Record</h2>
            <form id="data-form" novalidate>
                <input type="hidden" id="rowIndex" name="rowIndex">
                <div id="form-fields-container"></div>
                <div class="form-actions">
                    <button type="button" id="cancel-btn">Cancel</button>
                    <button type="submit" id="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2 id="confirm-title">Confirm Deletion</h2>
            <p id="confirm-message">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div class="form-actions">
                <button type="button" id="confirm-cancel-btn">Cancel</button>
                <button type="button" id="confirm-ok-btn">Yes, Delete</button>
            </div>
        </div>
    </div>
    <div id="info-modal" class="modal">
        <div class="modal-content">
             <span class="close-btn">&times;</span>
            <h2 id="info-title">Information</h2>
            <p id="info-message"></p>
            <div class="form-actions">
                 <button type="button" class="info-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjtl3u4mmtgD4KmvFE9ZrSleofoJM2SMtR1Parea8WYph6e9lsJeyV4ma6vGSx_2Nn/exec';

        // --- Get All Elements ---
        const tableHead = document.getElementById('data-table-head');
        const tableBody = document.getElementById('data-table-body');
        const loader = document.getElementById('loader');
        const tableWrapper = document.getElementById('table-wrapper');
        const addNewBtn = document.getElementById('addNewBtn');
        const dataModal = document.getElementById('data-modal');
        const closeModalBtn = dataModal.querySelector('.close-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const dataForm = document.getElementById('data-form');
        const modalTitle = document.getElementById('modal-title');
        const rowIndexInput = document.getElementById('rowIndex');
        const saveBtn = document.getElementById('save-btn');
        const formFieldsContainer = document.getElementById('form-fields-container');
        const yearFilter = document.getElementById('yearFilter');
        const dateFilter = document.getElementById('dateFilter');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const infoModal = document.getElementById('info-modal');
        const infoTitle = document.getElementById('info-title');
        const infoMessage = document.getElementById('info-message');
        const infoOkBtn = infoModal.querySelector('.info-ok-btn');
        const infoCloseBtn = infoModal.querySelector('.close-btn');
        const recordCountDisplay = document.getElementById('record-count-display');

        // --- Global State ---
        let sheetHeaders = [];
        let uniqueValues = {};
        let allRecords = [];

        // --- Configuration ---
        const fixedDropdownOptions = { 'status': ['confirmed', 'pending', 'cancelled', 'not-booked'], 'type': ['travel', 'stay', 'food', 'activity', 'other'], 'berth': ['UPPER BIRTH', 'MIDDLE BIRTH', 'LOWER BIRTH', 'SIDE UPPER', 'SIDE LOWER', 'WINDOW SEAT', 'N/A'] };
        const dynamicDatalistColumns = ['guest_name', 'guest_initials', 'departure_city', 'arrival_city'];
        const specialInputTypes = { 'check_in_date': 'date', 'check_out_date': 'date', 'start_date': 'date', 'end_date': 'date', 'check_in_time': 'time', 'check_out_time': 'time', 'start_time': 'time', 'end_time': 'time' };
        const durationDaysColumn = 'duration_days';
        const durationHoursColumn = 'duration_hours';
        const dateMonthColumn = 'date_month';
        const monthMap = { "January": "01", "February": "02", "March": "03", "April": "04", "May": "05", "June": "06", "July": "07", "August": "08", "September": "09", "October": "10", "November": "11", "December": "12" };
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        const formFieldConfig = {
            'stay': ['date_month','year','type','status','name','booking_no_pnr','check_in_date','check_in_time','check_out_date','check_out_time','duration_days','duration_hours','guest_name','guest_initials','fare','pdf_link'],
            'travel': ['date_month','year','type','status','name','booking_no_pnr','start_time','end_time','start_date','end_date','duration_days','duration_hours','guest_name','guest_initials','fare','train_no','departure_city','arrival_city','seat_no','berth','pdf_link']
        };

        // --- Helper Functions ---
        function parseSheetDate(dateStr) { if (!dateStr) return ''; const parts = dateStr.replace(/,/g, '').split(' '); if (parts.length < 3) return ''; const day = parts[0].padStart(2, '0'); const month = monthMap[parts[1]]; const year = parts[2]; if (!day || !month || !year) return ''; return `${year}-${month}-${day}`; }
        function formatForSheet(dateStr) { if (!dateStr) return ''; const [year, month, day] = dateStr.split('-'); const date = new Date(year, month - 1, day); return date.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }); }

        // NEW: Function to sort records by year and date
        function sortRecords(records) {
            records.sort((a, b) => {
                const yearA = parseInt(a.year, 10) || 0;
                const yearB = parseInt(b.year, 10) || 0;
                
                if (yearB !== yearA) {
                    return yearB - yearA; // Sort by year descending
                }

                // If years are the same, sort by date_month ascending
                try {
                    const dateA = new Date(a.date_month + ", " + yearA);
                    const dateB = new Date(b.date_month + ", " + yearB);
                    return dateA - dateB;
                } catch (e) {
                    return a.date_month.localeCompare(b.date_month); // Fallback sort
                }
            });
        }

        // --- Core Application Logic ---
        async function fetchData() {
            showLoader(true);
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                sheetHeaders = data.headers;
                uniqueValues = data.uniqueValues;
                allRecords = data.rows; 
                
                // NEW: Sort all records initially to group them by date
                sortRecords(allRecords);

                populateFilters(allRecords); 
                renderTable(sheetHeaders, allRecords); 
            } catch (error) {
                console.error('Error fetching data:', error);
                showInfo('Fetch Error', 'Failed to fetch data. Please check your internet connection and the Web App URL.');
            } finally {
                showLoader(false);
            }
        }

        function renderTable(headers, rows) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // UPDATED: Display Record Count
            const totalRecords = allRecords.length;
            if (rows.length === totalRecords) {
                recordCountDisplay.textContent = `Displaying all ${totalRecords} records.`;
            } else {
                recordCountDisplay.textContent = `Displaying ${rows.length} of ${totalRecords} records.`;
            }

            const headerRow = document.createElement('tr');
            headers.forEach(header => { headerRow.innerHTML += `<th>${escapeHtml(header)}</th>`; });
            headerRow.innerHTML += `<th class="actions">Actions</th>`;
            tableHead.appendChild(headerRow);
            if (rows.length === 0) { tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" style="text-align:center;">No records found for the selected filter.</td></tr>`; return; }
            
            // UPDATED: Logic for Row Coloring by Month
            let lastMonth = null;
            let colorIndex = 0;

            rows.forEach(item => {
                const currentMonth = item[dateMonthColumn];
                if (currentMonth !== lastMonth) {
                    colorIndex = (colorIndex + 1) % 2; // Alternates between 0 and 1
                    lastMonth = currentMonth;
                }

                const row = document.createElement('tr');
                row.classList.add(`color-group-${colorIndex + 1}`); // Add class for color

                let cells = '';
                headers.forEach(header => { cells += `<td>${escapeHtml(item[header])}</td>`; });
                row.innerHTML = cells + `
                    <td class="actions">
                        <button class="edit-btn" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M19.769 9.923l-12.642 12.639-7.127 1.438 1.438-7.127 12.641-12.64 5.69 5.691zm1.414-1.414l2.817-2.817-5.69-5.69-2.816 2.817 5.689 5.69z"/></svg></button>
                        <button class="delete-btn" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"/></svg></button>
                    </td>`;
                row.querySelector('.edit-btn').addEventListener('click', () => openModal(item));
                row.querySelector('.delete-btn').addEventListener('click', () => showDeleteConfirm(item.rowIndex));
                tableBody.appendChild(row);
            });
        }

        function populateFilters(records) {
            const uniqueYears = [...new Set(records.map(record => record.year).filter(Boolean))].sort((a,b) => b - a);
            yearFilter.innerHTML = '<option value="all">All Years</option>';
            uniqueYears.forEach(year => yearFilter.add(new Option(year, year)));
            updateDateFilter();
        }
        
        function updateDateFilter() {
            const selectedYear = yearFilter.value;
            const recordsToUse = (selectedYear === 'all') ? allRecords : allRecords.filter(record => String(record.year) === selectedYear);
            const uniqueDates = [...new Set(recordsToUse.map(record => record.date_month).filter(Boolean))];
            uniqueDates.sort((a, b) => {
                const dateA = new Date(a + " 1, 2000"); // Use a dummy year for sorting months
                const dateB = new Date(b + " 1, 2000");
                return dateA - dateB;
            });
            dateFilter.innerHTML = '<option value="all">All Dates</option>';
            uniqueDates.forEach(date => dateFilter.add(new Option(date, date)));
        }
        
        function applyFilter() {
            const selectedYear = yearFilter.value;
            const selectedDate = dateFilter.value;
            let filteredRecords = allRecords;
            if (selectedYear !== 'all') filteredRecords = filteredRecords.filter(record => String(record.year) === selectedYear);
            if (selectedDate !== 'all') filteredRecords = filteredRecords.filter(record => record.date_month === selectedDate);
            renderTable(sheetHeaders, filteredRecords);
        }
        
        function updateFormVisibility(selectedType) {
            const fieldsToShow = formFieldConfig[selectedType] || sheetHeaders;
            const allFormFields = formFieldsContainer.querySelectorAll('div[data-field-name]');
            allFormFields.forEach(fieldDiv => {
                const fieldName = fieldDiv.dataset.fieldName;
                fieldDiv.style.display = fieldsToShow.includes(fieldName) ? 'block' : 'none';
            });
        }

        function openModal(record = null) {
            dataForm.reset();
            formFieldsContainer.innerHTML = '';
            
            sheetHeaders.forEach(header => {
                const value = record ? record[header] : '';
                let fieldHTML = '';
                const isRequired = ['year', 'type', 'status', 'name'].includes(header); // UPDATED: Fields for validation

                if (fixedDropdownOptions.hasOwnProperty(header)) {
                    const optionsHTML = fixedDropdownOptions[header].map(o => `<option value="${escapeHtml(o)}" ${value === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('');
                    fieldHTML = `<div data-field-name="${header}"><label>${header}</label><select name="${header}" ${isRequired ? 'required' : ''}>${optionsHTML}</select></div>`;
                } else if (dynamicDatalistColumns.includes(header)) {
                    const optionsHTML = (uniqueValues[header] || []).map(o => `<option value="${escapeHtml(o)}"></option>`).join('');
                    fieldHTML = `<div data-field-name="${header}"><label>${header}</label><input type="text" name="${header}" list="${header}-datalist" value="${escapeHtml(value)}" autocomplete="off" ${isRequired ? 'required' : ''}><datalist id="${header}-datalist">${optionsHTML}</datalist></div>`;
                } else if (specialInputTypes.hasOwnProperty(header)) {
                    const inputType = specialInputTypes[header];
                    const formattedValue = (inputType === 'date' && value) ? parseSheetDate(value) : value;
                    fieldHTML = `<div data-field-name="${header}"><label>${header}</label><input type="${inputType}" name="${header}" value="${escapeHtml(formattedValue)}" ${isRequired ? 'required' : ''}></div>`;
                } else if (header === dateMonthColumn) {
                    let [currentDay, currentMonth] = value ? value.split(' ') : ['01', 'January'];
                    currentDay = parseInt(currentDay, 10);
                    let daysOptions = ''; for (let i = 1; i <= 31; i++) daysOptions += `<option value="${i}" ${i === currentDay ? 'selected' : ''}>${String(i).padStart(2, '0')}</option>`;
                    const monthsOptions = months.map(m => `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>`).join('');
                    fieldHTML = `<div data-field-name="date_month"><label>date_month</label><div class="day-month-picker"><select id="date_month-day-picker">${daysOptions}</select><select id="date_month-month-picker">${monthsOptions}</select></div></div>`;
                } else if (header === durationDaysColumn) {
                    let optionsHTML = ''; for (let i = 0; i <= 10; i++) { const dayValue = `${i} Day${i !== 1 ? 's' : ''}`; optionsHTML += `<option value="${dayValue}" ${value === dayValue ? 'selected' : ''}>${dayValue}</option>`;}
                    fieldHTML = `<div data-field-name="duration_days"><label>duration_days</label><select name="duration_days">${optionsHTML}</select></div>`;
                } else if (header === durationHoursColumn) {
                    let [currentHours, currentMinutes] = [0, 0];
                    if (value) { const h = value.match(/(\d+)h/); const m = value.match(/(\d+)m/); if (h) currentHours = parseInt(h[1], 10); if (m) currentMinutes = parseInt(m[1], 10);}
                    let hoursOptions = ''; for (let i = 0; i < 24; i++) hoursOptions += `<option value="${i}" ${i === currentHours ? 'selected' : ''}>${i}h</option>`;
                    let minutesOptions = ''; for (let i = 0; i < 60; i++) minutesOptions += `<option value="${i}" ${i === currentMinutes ? 'selected' : ''}>${i}m</option>`;
                    fieldHTML = `<div data-field-name="duration_hours"><label>duration_hours</label><div class="duration-picker"><select id="duration_hours-h-picker">${hoursOptions}</select><select id="duration_hours-m-picker">${minutesOptions}</select></div></div>`;
                } else {
                    fieldHTML = `<div data-field-name="${header}"><label>${header}</label><input type="text" name="${header}" value="${escapeHtml(value)}" ${isRequired ? 'required' : ''}></div>`;
                }
                formFieldsContainer.innerHTML += fieldHTML;
            });
            
            const typeSelect = formFieldsContainer.querySelector('[name="type"]');
            if(typeSelect) {
                typeSelect.addEventListener('change', () => updateFormVisibility(typeSelect.value));
                updateFormVisibility(record ? record.type : typeSelect.value);
            }

            modalTitle.textContent = record ? 'Edit Record' : 'Add New Record';
            rowIndexInput.value = record ? record.rowIndex : '';
            dataModal.style.display = 'block';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            // UPDATED: Better Form Validation
            if (!dataForm.checkValidity()) {
                dataForm.reportValidity(); // Shows browser's native validation hints
                return;
            }

            // UPDATED: Improved Loading Indicator
            saveBtn.disabled = true;
            const originalButtonContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<div class="btn-loader"></div>';

            const formData = new FormData(dataForm);
            if (document.getElementById('date_month-day-picker')) { formData.set('date_month', `${String(document.getElementById('date_month-day-picker').value).padStart(2, '0')} ${document.getElementById('date_month-month-picker').value}`); }
            if (document.getElementById('duration_hours-h-picker')) { formData.set('duration_hours', `${document.getElementById('duration_hours-h-picker').value}h ${document.getElementById('duration_hours-m-picker').value}m`);}
            for (const header in specialInputTypes) { if (specialInputTypes[header] === 'date' && formData.has(header) && formData.get(header)) { formData.set(header, formatForSheet(formData.get(header))); } }
            formData.append('action', rowIndexInput.value ? 'update' : 'create');
            
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'SUCCESS') {
                    dataModal.style.display = 'none';
                    await fetchData();
                } else {
                    // UPDATED: More Specific Error Messages
                    throw new Error(result.message || 'An unknown server error occurred.');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showInfo('Save Error', `Failed to save record: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalButtonContent;
            }
        }

        async function deleteRecord() {
            const rowIndex = confirmOkBtn.dataset.rowIndex;
            confirmModal.style.display = 'none';
            showLoader(true);
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', rowIndex);
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'SUCCESS') { await fetchData(); } 
                else { throw new Error(result.message); }
            } catch(error) {
                console.error('Error deleting record:', error);
                showInfo('Delete Error', `Failed to delete record: ${error.message}`);
                showLoader(false);
            }
        }

        function showInfo(title, message) { infoTitle.textContent = title; infoMessage.textContent = message; infoModal.style.display = 'block'; }
        function showDeleteConfirm(rowIndex) { confirmOkBtn.dataset.rowIndex = rowIndex; confirmModal.style.display = 'block'; }
        function showLoader(show) { if (!loader || !tableWrapper) return; loader.style.display = show ? 'block' : 'none'; tableWrapper.style.display = show ? 'none' : 'block'; }
        function escapeHtml(unsafe) { return String(unsafe || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

        // --- Theme Switcher Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        function switchTheme(e) { document.body.classList.toggle('dark-mode', e.target.checked); localStorage.setItem('theme', e.target.checked ? 'dark' : 'light'); }
        themeToggle.addEventListener('change', switchTheme);
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) { themeToggle.checked = currentTheme === 'dark'; document.body.classList.toggle('dark-mode', currentTheme === 'dark'); }
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { themeToggle.checked = true; document.body.classList.add('dark-mode'); }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', fetchData);
        addNewBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', () => dataModal.style.display = 'none');
        cancelBtn.addEventListener('click', () => dataModal.style.display = 'none');
        dataForm.addEventListener('submit', handleFormSubmit);
        yearFilter.addEventListener('change', () => { updateDateFilter(); applyFilter(); });
        dateFilter.addEventListener('change', applyFilter);
        confirmCancelBtn.addEventListener('click', () => confirmModal.style.display = 'none');
        confirmOkBtn.addEventListener('click', deleteRecord);
        infoOkBtn.addEventListener('click', () => infoModal.style.display = 'none');
        infoCloseBtn.addEventListener('click', () => infoModal.style.display = 'none');
        window.addEventListener('click', (event) => { if (event.target == dataModal) dataModal.style.display = 'none'; if (event.target == confirmModal) confirmModal.style.display = 'none'; if (event.target == infoModal) infoModal.style.display = 'none'; });

    </script>
</body>
</html>



